import os
import time
from colorama import init, Fore, Back, Style
from DataPersistence import HabitTrackerDB
from User import User
from Habit import Habit
from Analytics import Analytics

init(autoreset=True)

db = HabitTrackerDB()
analytics = Analytics(db)

def clear_screen():
    os.system('cls' if os.name == 'nt' else 'clear')

def print_header():
    print(Fore.CYAN + Style.BRIGHT + """
🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟

                     🎯 Alonso's Habit Tracker 🎯

🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟✨🌟
    """)

def print_menu():
    print(Fore.YELLOW + "\n📋 Main Menu:")
    print(Fore.GREEN + "1. 👤 Manage Users")
    print(Fore.GREEN + "2. 🏋️ Manage Habits")
    print(Fore.GREEN + "3. 📊 View Analytics")
    print(Fore.GREEN + "4. 🚪 Exit")

def manage_users():
    while True:
        clear_screen()
        print_header()
        print(Fore.YELLOW + "\n👥 User Management:")
        print(Fore.GREEN + "1. ➕ Add User")
        print(Fore.GREEN + "2. 🔍 View Users")
        print(Fore.GREEN + "3. ↩️ Back to Main Menu")
        
        choice = input(Fore.MAGENTA + "\nEnter your choice: ")
        
        if choice == '1':
            username = input(Fore.CYAN + "Enter username: ")
            db.add_user(username)
            print(Fore.GREEN + f"✅ User {username} added successfully!")
        elif choice == '2':
            users = db.get_users()
            print(Fore.CYAN + "\nUsers:")
            for user in users:
                print(Fore.WHITE + f"ID: {user[0]}, Username: {user[1]}")
        elif choice == '3':
            break
        else:
            print(Fore.RED + "❌ Invalid choice. Please try again.")
        
        input(Fore.YELLOW + "\nPress Enter to continue...")

def manage_habits():
    while True:
        clear_screen()
        print_header()
        print(Fore.YELLOW + "\n🏋️ Habit Management:")
        print(Fore.GREEN + "1. ➕ Add Habit")
        print(Fore.GREEN + "2. 🔍 View Habits")
        print(Fore.GREEN + "3. ✅ Mark Habit as Complete")
        print(Fore.GREEN + "4. ↩️ Back to Main Menu")
        
        choice = input(Fore.MAGENTA + "\nEnter your choice: ")
        
        if choice == '1':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            name = input(Fore.CYAN + "Enter habit name: ")
            description = input(Fore.CYAN + "Enter habit description: ")
            periodicity = input(Fore.CYAN + "Enter periodicity (daily/weekly): ")
            creation_date = time.strftime('%Y-%m-%d')
            db.add_habit(name, description, periodicity, creation_date, user_id)
            print(Fore.GREEN + f"✅ Habit '{name}' added successfully!")
        elif choice == '2':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            habits = db.get_habits_by_user(user_id)
            print(Fore.CYAN + "\nHabits:")
            for habit in habits:
                print(Fore.WHITE + f"ID: {habit[0]}, Name: {habit[1]}, Periodicity: {habit[3]}")
        elif choice == '3':
            habit_id = int(input(Fore.CYAN + "Enter habit ID: "))
            completion_date = time.strftime('%Y-%m-%d')
            db.add_completion(habit_id, completion_date)
            print(Fore.GREEN + f"✅ Habit marked as complete for {completion_date}!")
        elif choice == '4':
            break
        else:
            print(Fore.RED + "❌ Invalid choice. Please try again.")
        
        input(Fore.YELLOW + "\nPress Enter to continue...")

def view_analytics():
    while True:
        clear_screen()
        print_header()
        print(Fore.YELLOW + "\n📊 Analytics:")
        print(Fore.GREEN + "1. 📈 View All Habits")
        print(Fore.GREEN + "2. 🔍 View Habits by Periodicity")
        print(Fore.GREEN + "3. 🏆 View Longest Streak")
        print(Fore.GREEN + "4. ↩️ Back to Main Menu")
        
        choice = input(Fore.MAGENTA + "\nEnter your choice: ")
        
        if choice == '1':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            habits = analytics.getAllHabits(user_id)
            print(Fore.CYAN + "\nAll Habits:")
            for habit in habits:
                print(Fore.WHITE + f"ID: {habit[0]}, Name: {habit[1]}, Periodicity: {habit[3]}")
        elif choice == '2':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            periodicity = input(Fore.CYAN + "Enter periodicity (daily/weekly): ")
            habits = analytics.getHabitsByPeriodicity(user_id, periodicity)
            print(Fore.CYAN + f"\n{periodicity.capitalize()} Habits:")
            for habit in habits:
                print(Fore.WHITE + f"ID: {habit[0]}, Name: {habit[1]}")
        elif choice == '3':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            longest_streaks = analytics.getLongestStreakAllHabits(user_id)
            print(Fore.CYAN + "\nLongest Streaks:")
            for habit_id, streak in longest_streaks.items():
                habit = db.get_habit(habit_id)
                print(Fore.WHITE + f"Habit: {habit[1]}, Longest Streak: {streak} days")
        elif choice == '4':
            break
        else:
            print(Fore.RED + "❌ Invalid choice. Please try again.")
        
        input(Fore.YELLOW + "\nPress Enter to continue...")

def main():
    while True:
        clear_screen()
        print_header()
        print_menu()
        choice = input(Fore.MAGENTA + "\nEnter your choice: ")

        if choice == '1':
            manage_users()
        elif choice == '2':
            manage_habits()
        elif choice == '3':
            view_analytics()
        elif choice == '4':
            print(Fore.YELLOW + "\n👋 Thank you for using Alonso's Habit Tracker! Goodbye! 🌟")
            break
        else:
            print(Fore.RED + "❌ Invalid choice. Please try again.")

        time.sleep(1)


if __name__ == "__main__":
    main()