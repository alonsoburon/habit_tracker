import os
import time
from colorama import init, Fore, Back, Style
from DataPersistence import HabitTrackerDB
from User import User
from Habit import Habit
from Analytics import Analytics

init(autoreset=True)

db = HabitTrackerDB()
analytics = Analytics(db)

def clear_screen():
    os.system('cls' if os.name == 'nt' else 'clear')

def print_header():
    print(Fore.CYAN + Style.BRIGHT + """
ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸ

                     ğŸ¯ Alonso's Habit Tracker ğŸ¯

ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸâœ¨ğŸŒŸ
    """)

def print_menu():
    print(Fore.YELLOW + "\nğŸ“‹ Main Menu:")
    print(Fore.GREEN + "1. ğŸ‘¤ Manage Users")
    print(Fore.GREEN + "2. ğŸ‹ï¸ Manage Habits")
    print(Fore.GREEN + "3. ğŸ“Š View Analytics")
    print(Fore.GREEN + "4. ğŸšª Exit")

def manage_users():
    while True:
        clear_screen()
        print_header()
        print(Fore.YELLOW + "\nğŸ‘¥ User Management:")
        print(Fore.GREEN + "1. â• Add User")
        print(Fore.GREEN + "2. ğŸ” View Users")
        print(Fore.GREEN + "3. â†©ï¸ Back to Main Menu")
        
        choice = input(Fore.MAGENTA + "\nEnter your choice: ")
        
        if choice == '1':
            username = input(Fore.CYAN + "Enter username: ")
            db.add_user(username)
            print(Fore.GREEN + f"âœ… User {username} added successfully!")
        elif choice == '2':
            users = db.get_users()
            print(Fore.CYAN + "\nUsers:")
            for user in users:
                print(Fore.WHITE + f"ID: {user[0]}, Username: {user[1]}")
        elif choice == '3':
            break
        else:
            print(Fore.RED + "âŒ Invalid choice. Please try again.")
        
        input(Fore.YELLOW + "\nPress Enter to continue...")

def manage_habits():
    while True:
        clear_screen()
        print_header()
        print(Fore.YELLOW + "\nğŸ‹ï¸ Habit Management:")
        print(Fore.GREEN + "1. â• Add Habit")
        print(Fore.GREEN + "2. ğŸ” View Habits")
        print(Fore.GREEN + "3. âœ… Mark Habit as Complete")
        print(Fore.GREEN + "4. â†©ï¸ Back to Main Menu")
        
        choice = input(Fore.MAGENTA + "\nEnter your choice: ")
        
        if choice == '1':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            name = input(Fore.CYAN + "Enter habit name: ")
            description = input(Fore.CYAN + "Enter habit description: ")
            periodicity = input(Fore.CYAN + "Enter periodicity (daily/weekly): ")
            creation_date = time.strftime('%Y-%m-%d')
            db.add_habit(name, description, periodicity, creation_date, user_id)
            print(Fore.GREEN + f"âœ… Habit '{name}' added successfully!")
        elif choice == '2':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            habits = db.get_habits_by_user(user_id)
            print(Fore.CYAN + "\nHabits:")
            for habit in habits:
                print(Fore.WHITE + f"ID: {habit[0]}, Name: {habit[1]}, Periodicity: {habit[3]}")
        elif choice == '3':
            habit_id = int(input(Fore.CYAN + "Enter habit ID: "))
            completion_date = time.strftime('%Y-%m-%d')
            db.add_completion(habit_id, completion_date)
            print(Fore.GREEN + f"âœ… Habit marked as complete for {completion_date}!")
        elif choice == '4':
            break
        else:
            print(Fore.RED + "âŒ Invalid choice. Please try again.")
        
        input(Fore.YELLOW + "\nPress Enter to continue...")

def view_analytics():
    while True:
        clear_screen()
        print_header()
        print(Fore.YELLOW + "\nğŸ“Š Analytics:")
        print(Fore.GREEN + "1. ğŸ“ˆ View All Habits")
        print(Fore.GREEN + "2. ğŸ” View Habits by Periodicity")
        print(Fore.GREEN + "3. ğŸ† View Longest Streak")
        print(Fore.GREEN + "4. â†©ï¸ Back to Main Menu")
        
        choice = input(Fore.MAGENTA + "\nEnter your choice: ")
        
        if choice == '1':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            habits = analytics.getAllHabits(user_id)
            print(Fore.CYAN + "\nAll Habits:")
            for habit in habits:
                print(Fore.WHITE + f"ID: {habit[0]}, Name: {habit[1]}, Periodicity: {habit[3]}")
        elif choice == '2':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            periodicity = input(Fore.CYAN + "Enter periodicity (daily/weekly): ")
            habits = analytics.getHabitsByPeriodicity(user_id, periodicity)
            print(Fore.CYAN + f"\n{periodicity.capitalize()} Habits:")
            for habit in habits:
                print(Fore.WHITE + f"ID: {habit[0]}, Name: {habit[1]}")
        elif choice == '3':
            user_id = int(input(Fore.CYAN + "Enter user ID: "))
            longest_streaks = analytics.getLongestStreakAllHabits(user_id)
            print(Fore.CYAN + "\nLongest Streaks:")
            for habit_id, streak in longest_streaks.items():
                habit = db.get_habit(habit_id)
                print(Fore.WHITE + f"Habit: {habit[1]}, Longest Streak: {streak} days")
        elif choice == '4':
            break
        else:
            print(Fore.RED + "âŒ Invalid choice. Please try again.")
        
        input(Fore.YELLOW + "\nPress Enter to continue...")

def main():
    while True:
        clear_screen()
        print_header()
        print_menu()
        choice = input(Fore.MAGENTA + "\nEnter your choice: ")

        if choice == '1':
            manage_users()
        elif choice == '2':
            manage_habits()
        elif choice == '3':
            view_analytics()
        elif choice == '4':
            print(Fore.YELLOW + "\nğŸ‘‹ Thank you for using Alonso's Habit Tracker! Goodbye! ğŸŒŸ")
            break
        else:
            print(Fore.RED + "âŒ Invalid choice. Please try again.")

        time.sleep(1)


if __name__ == "__main__":
    main()